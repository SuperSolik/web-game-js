(()=>{"use strict";class t{constructor(t,s){this.x=t,this.y=s}plus(s){return new t(this.x+s.x,this.y+s.y)}multiply(s){return new t(this.x*s,this.y*s)}copy(){return new t(this.x,this.y)}}class s{constructor(t,s,e=0,i=0,h=null){this.pos=t,this.vel=s,this.width=e,this.height=i,this.sprite=h,this.destroy=!1,this.curFrame=0,this.changeSprite=!0,this.oldPos=null}savePos(){this.oldPos=this.pos.copy()}restorePos(){this.pos=this.oldPos}update(){this.pos=this.pos.plus(this.vel)}draw(t){let s=t.gameSpriteInfo[this.sprite];t.ctx.drawImage(t.gameSprites,s.x+16*this.curFrame,s.y,s.w,s.h,this.pos.x,this.pos.y,this.width,this.height),this.changeSpriteFrame(s)}changeSpriteFrame(t){this.changeSprite&&(this.curFrame=(this.curFrame+1)%(t.animLen||3),this.changeSprite=!1,setTimeout((()=>{this.changeSprite=!0}),125))}}class e extends s{constructor(t,s,e,i,h=null){super(t,s,e,i,h),this.fromPlayer=!1,this.angle=0}static get SIZE(){return 20}static createBullet(s,i,h="red",o=!1){const a=new e(new t(s.x+e.SIZE/2*Math.cos(i),s.y+e.SIZE/2*Math.sin(i)),new t(10*Math.cos(i),10*Math.sin(i)),e.SIZE,e.SIZE,h);return a.angle=i,a.fromPlayer=o,a}hit(t){(this.fromPlayer&&t instanceof h||!this.fromPlayer&&t instanceof i)&&(t.destroy=!0,this.destroy=!0)}draw(t){let s=t.bulletsSprites[this.sprite];t.ctx.save(),t.ctx.translate(this.pos.x+this.width/2,this.pos.y+this.height/2),t.ctx.rotate(this.angle),t.ctx.drawImage(s,16*this.curFrame,0,16,16,-2*this.width/2,-2*this.height/2,2*this.width,2*this.height),t.ctx.restore(),this.changeSpriteFrame(s)}}class i extends s{moveLeft(){this.vel=new t(-6,this.vel.y)}moveRight(){this.vel=new t(6,this.vel.y)}moveUp(){this.vel=new t(this.vel.x,-6)}moveDown(){this.vel=new t(this.vel.x,6)}stopX(){this.vel=new t(0,this.vel.y)}stopY(){this.vel=new t(this.vel.x,0)}shoot(s,i){let h=this.pos.plus(new t(this.width/2-e.SIZE/2,this.height/2-e.SIZE/2)),o=i.plus(new t(e.SIZE/2,e.SIZE/2).multiply(-1));const a=Math.atan2(o.y-h.y,o.x-h.x),n=e.createBullet(h,a,"yellow",!0);s.push(n)}}class h extends s{constructor(t,s,e=0,i=0,h=null){super(t,s,e,i,h),this.shooting=!1,this.hasShotgun=!1,setTimeout((()=>{this.shooting=!0}),1e3*Math.random()+500)}shoot(s,i){if(this.shooting){const h=this.hasShotgun?3:1;let o=this.pos.plus(new t(this.width/2-e.SIZE/2,this.height/2-e.SIZE/2)),a=i.plus(new t(e.SIZE/2,e.SIZE/2).multiply(-1));const n=Math.atan2(a.y-o.y,a.x-o.x),l=n-Math.floor(h/2)*Math.PI/5,r=n+Math.floor(h/2)*Math.PI/5;for(let t=l;t<=r;t+=Math.PI/5)s.push(e.createBullet(o,t));this.shooting=!1}}}class o{constructor(s){this.rect=s.getBoundingClientRect(),document.addEventListener("keydown",(t=>this.onKeyDown(t))),document.addEventListener("keyup",(t=>this.onKeyUp(t))),s.addEventListener("mousedown",(t=>this.getMousePos(t))),this.action={left:!1,right:!1,shoot:!1,up:!1,down:!1},this.bind={KeyA:"left",KeyD:"right",KeyW:"up",KeyS:"down"},this.mouseCoords=new t(0,0)}onKeyDown(t){let s=this.bind[t.code];s&&(this.action[s]=!0,t.preventDefault())}onKeyUp(t){let s=this.bind[t.code];s&&(this.action[s]=!1,t.preventDefault())}getMousePos(s){this.mouseCoords=new t(s.clientX-this.rect.left,s.clientY-this.rect.top),this.action.shoot=!0}}class a{constructor(t){this.ctx=t,this.sprites=null,this.spritesInfo=null,this.bulletsSprites={}}async init(){this.sprites=new Image,await new Promise((t=>{this.sprites.onload=()=>t("ok"),this.sprites.src="sprites/set.png"})),await new Promise((t=>{let s=0;for(let e of["red","yellow"]){const i=new Image;i.onload=()=>{this.bulletsSprites[e]=i,s++,2===s&&t("ok")},i.src=`sprites/proj_${e}.png`}})),await new Promise((t=>{fetch("data/entities.json").then((t=>t.json())).then((s=>{this.spritesInfo=s,t("ok")})).catch((t=>t))}))}clear(){this.ctx.fillStyle="black",this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height)}draw(t){t instanceof Array?t.forEach((t=>this.draw(t))):t.draw({ctx:this.ctx,bulletsSprites:this.bulletsSprites,gameSprites:this.sprites,gameSpriteInfo:this.spritesInfo})}drawMapBottom(t){t.imgLoaded&&t.jsonLoaded||setTimeout((()=>this.drawMapBottom(t)),100),this.drawLevel(t,t.bottomLayer),this.drawLevel(t,t.middleLayer)}drawMapTop(t){t.imgLoaded&&t.jsonLoaded||setTimeout((()=>this.drawMapTop(t)),100),this.drawLevel(t,t.topLayer)}drawLevel(t,s){for(let e=0;e<s.data.length;e++)if(0!==s.data[e]){let i=t.getTile(s.data[e]),h=e%t.xCount*t.tSize.x,o=Math.floor(e/t.xCount)*t.tSize.y;this.ctx.drawImage(i.img,i.px,i.py,t.tSize.x,t.tSize.y,2*h,2*o,32,32)}}}class n{constructor(t){this.map=t,this.isTouchExit=!1}handleBullet(t,s){const e=s[0];this.collide(t,e)&&t.hit(e);for(let e of s)if(this.collide(t,e)){t.hit(e);break}this.move(t,!0)}handleEnemy(s,e){const i=e.pos.x-s.pos.x,h=e.pos.y-s.pos.y,o=Math.sqrt(i**2+h**2),a=Math.atan2(h,i),n=new t(4*Math.cos(a),4*Math.sin(a));s.vel=o>=300?n:o<250?n.multiply(-1):new t(0,0),this.move(s)}update(t){const s=t[0];this.move(s);for(let i of t.slice(1,t.length))i instanceof h&&this.handleEnemy(i,s),i instanceof e&&this.handleBullet(i,t)}move(t,s=!1){t.savePos(),t.update(),t instanceof i&&(this.isTouchExit=this.touchExit(t));const h=t instanceof e?3:1.5;(this.map.isWall(t.pos.x,t.pos.y+t.height/h)||this.map.isWall(t.pos.x+t.width,t.pos.y+t.height/h)||this.map.isWall(t.pos.x,t.pos.y+t.height)||this.map.isWall(t.pos.x+t.width,t.pos.y+t.height))&&(t.restorePos(),t.destroy=s)}touchExit(t){const s=t instanceof e?3:1.5;return this.map.isExit(t.pos.x,t.pos.y+t.height/s)||this.map.isExit(t.pos.x+t.width,t.pos.y+t.height/s)||this.map.isExit(t.pos.x,t.pos.y+t.height)||this.map.isExit(t.pos.x+t.width,t.pos.y+t.height)}collide(t,s){return t.pos.x<=s.pos.x+s.width&&t.pos.x+t.width>=s.pos.x&&t.pos.y<=s.pos.y+s.height&&t.pos.y+t.height>=s.pos.y}}class l{constructor(){this.mapData=null,this.xCount=0,this.yCount=0,this.tSize={x:32,y:32},this.mapSize={x:32,y:32},this.tilesets=[],this.imgLoadCount=0,this.imgLoaded=!1,this.jsonLoaded=!1,this.width=null,this.height=null,this.topLayer=null,this.middleLayer=null,this.bottomLayer=null,this.levelNum=0}async loadLevel(){let t=await fetch(`data/level${++this.levelNum}.json`);return await t.json()}parseMap(t){this.mapData=t,this.xCount=this.mapData.width,this.yCount=this.mapData.height,this.tSize.x=this.mapData.tilewidth,this.tSize.y=this.mapData.tileheight,this.mapSize.x=this.xCount*this.tSize.x,this.mapSize.y=this.yCount*this.tSize.y,this.width=2*this.mapSize.x,this.height=2*this.mapSize.y;for(let t=0;t<this.mapData.tilesets.length;t++){let s=new Image;s.onload=()=>{this.imgLoadCount++,this.imgLoadCount===this.mapData.tilesets.length&&(this.imgLoaded=!0)},s.src=this.mapData.tilesets[t].image;let e=this.mapData.tilesets[t],i={firstgid:e.firstgid,image:s,name:e.name,xCount:Math.floor(e.imagewidth/this.tSize.x),yCount:Math.floor(e.imageheight/this.tSize.y)};this.tilesets.push(i)}this.topLayer=this.mapData.layers.find((t=>"top"===t.name)),this.middleLayer=this.mapData.layers.find((t=>"middle"===t.name)),this.bottomLayer=this.mapData.layers.find((t=>"bottom"===t.name)),this.jsonLoaded=!0}isWall(t,s){let e=Math.floor(t/2),i=Math.floor(s/2),h=Math.floor(i/this.tSize.y)*this.xCount+Math.floor(e/this.tSize.x),o=this.middleLayer.data[h];return[34,257,258,199,101,37,597,291,292,259,260,483,484].find((t=>t===o))}isExit(t,s){let e=Math.floor(t/2),i=Math.floor(s/2),h=Math.floor(i/this.tSize.y)*this.xCount+Math.floor(e/this.tSize.x),o=this.middleLayer.data[h];return 483===o||484===o}getTile(t){let s={img:null,px:0,py:0},e=this.getTileset(t);s.img=e.image;let i=t-e.firstgid,h=i%e.xCount,o=Math.floor(i/e.xCount);return s.px=h*this.tSize.x,s.py=o*this.tSize.y,s}getTileset(t){for(let s=this.tilesets.length-1;s>=0;s--)if(this.tilesets[s].firstgid<=t)return this.tilesets[s];return null}parseObjects(s,e){const o=s.layers.find((t=>"objectgroup"===t.type));for(let s of o.objects)if("player"===s.type&&e.unshift(new i(new t(2*s.x,2*s.y),new t(0,0),32,64,"knight_f_run_anim")),"enemy"===s.type){let i=s.properties.find((t=>"shotgun"===t.name)),o=s.properties.find((t=>"sprite"===t.name));const a=new h(new t(2*s.x,2*s.y),new t(0,0),32,64,o.value);a.hasShotgun=i.value,e.push(a)}}}class r{constructor(){}play(t){let s=document.createElement("audio");s.src=`sounds/${t}.wav`,s.volume=.4,s.addEventListener("ended",(function(){document.removeChild(this)})),s.play()}}class c{constructor(t){this.controls=new o(t.canvas),this.render=new a(t.ctx),this.sound=new r,this.map=new l,this.physics=new n(this.map),this.actors=[],this.player=null,this.callbacks=t.callbacks,this.gameLoop=null,this.score=0,this.enemiesCount=0}update(){if(this.physics.isTouchExit&&this.enemiesCount<=0){if(this.sound.play("win"),this.map.levelNum>=2)return this.callbacks.gameOver(this.score,!0),void clearInterval(this.gameLoop);clearInterval(this.gameLoop),this.run()}if(this.render.clear(),this.controls.action.left?this.player.moveLeft():this.controls.action.right?this.player.moveRight():this.player.stopX(),this.controls.action.up?this.player.moveUp():this.controls.action.down?this.player.moveDown():this.player.stopY(),this.controls.action.shoot&&(this.sound.play("shot"),this.player.shoot(this.actors,this.controls.mouseCoords),this.controls.action.shoot=!1),this.actors.forEach((t=>{t.shooting&&(t.shoot(this.actors,this.player.pos),setTimeout((()=>{t.shooting=!0}),1500))})),this.physics.update(this.actors),this.player.destroy)return this.sound.play("fail"),this.player=null,clearInterval(this.gameLoop),void this.callbacks.gameOver(this.score);for(let t in this.actors)this.actors[t].destroy&&(this.actors[t]instanceof h&&(this.score+=10,this.enemiesCount--,this.callbacks.updateScore(this.score)),this.actors.splice(t,1));this.render.drawMapBottom(this.map),this.render.draw(this.actors),this.render.drawMapTop(this.map)}run(){this.player=null,this.actors=[],this.map.loadLevel().then((t=>{this.map.parseMap(t),this.map.parseObjects(t,this.actors)})),this.render.init().then((()=>{this.player=this.actors[0],this.enemiesCount=this.actors.filter((t=>t instanceof h)).length,this.gameLoop=setInterval((()=>this.update()),35)}))}}let p=null;document.addEventListener("DOMContentLoaded",(()=>{const t=document.getElementById("canvas"),s=t.getContext("2d"),e=document.querySelector(".gameover");function i(){s.clearRect(0,0,t.width,t.height),p=new c({ctx:s,canvas:t,callbacks:{updateScore:t=>console.log(`NEW SCORE IS ${t}`),gameOver:()=>{console.log("GAME OVER"),e.classList.add("show")}}}),p.run()}document.querySelector(".gameover button").onclick=()=>{e.classList.remove("show"),i()},i()}))})();